{% extends "projects/project_base.html" %}
{% load static %}
{% block head_block %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.material.min.css">
{% endblock %}

{% block breadcrumb %}
<a href="{% url 'projects:all' %}" class="breadcrumb">My Projects</a>
<a href="{% url 'projects:single' slug=project.slug %}" class="breadcrumb">{{ project.project_title }}</a>
<a href="" class="breadcrumb">
  <a  href="{% url 'projects:records:create' slug=project.slug %}"
      class="btn btn-small waves-light waves-effect cyan darken-3">
      Add entry
  </a>
</a>
{% endblock %}


{% block preproject %}{% endblock %}

{% block project_content %}

<div class="row">
  <div class="col s12">
    <div class="card grey lighten-5">
      <div class="card-content">
        <div class="row">
          <div class="col s12">
            <span class="card-title"><h2 class="center">{{ project.project_title }}
            <i class="material-icons small grey-text tooltipped" data-position="bottom" data-tooltip="{{ project.description }}">
              info_outline
            </i></h2>

        <h6 class="center">Choose what fields to show</h6>
      </div> <!-- close col s12 -->
    </div> <!-- close row -->
        <div class="row">
          <div class="col s4">

          </div>
              <form action="#">
                    <div class="col s12">


                      <div class="row">
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>Cite Key</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>Entry Type</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" value="title"/>
                            <span>Title</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>Author</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>Journal</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn"  />
                            <span>Editor</span>
                          </label>
                        </div>

                      </div>
                      <div class="row">
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" />
                            <span>Publisher</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>Year</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" />
                            <span>Month</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" />
                            <span>School</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" />
                            <span>Institution</span>
                          </label>
                        </div>
                        <div class="col s2">
                          <label>
                            <input type="checkbox" class="filled-in toggleColumn" checked="checked" />
                            <span>_Actions_</span>
                          </label>
                        </div>



                    </div>
              </form>




              <table class="mdl-data-table " style="width:100%" id="example">
                <!-- TABLE HEAD -->
                <thead>
                  <tr>
                    <th>Cite Key</th>
                    <th>Entry Type</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Journal</th>
                    <th>Editor</th>
                    <th>Publisher</th>
                    <th>Year</th>
                    <th>Month</th>
                    <th>School</th>
                    <th>Institution</th>
                    <th><span class="right">_Actions_</span></th>
                  </tr>
                </thead>
                <!-- END TABLE HEAD -->
                <tbody>
                  <!-- TABLE BODY -->
                  {% for record in project.records.all  %}
                    <tr >
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        <a href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">{{ record.cite_key }}</a>
                      </td>
                      <td class="clickable-row"
                          data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.entry_type %}{{ record.entry_type }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row tooltipped"
                          data-position="bottom"
                          data-tooltip="{{ record.title }}"
                          data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.title %}
                          {{ record.title|truncatechars:30 }}
                          <!-- This is only to be able to filter on the whole title -->
                          <span hidden>{{ record.title }}</span>
                        {% else %}
                           -
                        {% endif %}
                      </td>
                      <td class="clickable-row tooltipped"
                          data-position="bottom"
                          data-tooltip="{{ record.author }}"
                          data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.author %}
                          {{ record.author|truncatechars:30 }}
                          <!-- This is only to be able to filter on the whole title -->
                          <span hidden>{{ record.author }}</span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="clickable-row tooltipped"
                          data-position="bottom"
                          data-tooltip="{{ record.author }}"
                          data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.author %}
                          {{ record.journal|truncatechars:20 }}
                          <!-- This is only to be able to filter on the whole title -->
                          <span hidden>{{ record.journal }}</span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.editor %}{{ record.editor }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.publisher %}{{ record.publisher }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.year %}{{ record.year }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.month %}{{ record.month }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.school %}{{ record.school }}{% else %}-{% endif %}
                      </td>
                      <td class="clickable-row" data-href="{% url 'projects:records:single' slug=project.slug pk=record.pk %}">
                        {% if record.institution %}{{ record.institution }}{% else %}-{% endif %}
                      </td>


                      <td class="right">
                        <a  href="{% url 'projects:records:edit' slug=project.slug pk=record.pk %}" class="grey-text tooltipped"
                            data-position="top"
                            data-tooltip="Edit">
                          <i class="material-icons">edit</i>
                        </a>
                        <a href="{% url 'projects:records:clone' slug=project.slug pk=record.pk %}" class="grey-text tooltipped"
                            data-position="top"
                            data-tooltip="Copy">
                          <i class="material-icons">content_copy</i>
                        </a>
                        <a href="#delete_record{{ record.pk }}" class="grey-text tooltipped"
                            data-position="top"
                            data-tooltip="Delete">
                          <i class="material-icons">delete</i>
                        </a>
                      </td>
                    </tr>

                    <!-- Modal for each record needs to be inside for loop -->
                    <div id="delete_record{{ record.pk }}" class="modal">
                       <div class="modal-content">
                         <h4 class="center-align">Are you sure you want to delete this record?</h4>
                         <p class="center-align">Cite Key: '{{ record.cite_key }}'
                                              <br>Entry Type: '{{ record.entry_type }}'
                                              <br>Title: '{{ record.title }}'
                       </div>
                       <div class="modal-footer">
                         <div class="modal-action right-align">
                           <a href="#!" class="modal-close btn-flat waves-effect waves-blue grey-text">Cancel</a>
                           <a href="{% url 'projects:records:delete' slug=project.slug pk=record.pk %}" class="modal-close btn-flat waves-effect waves-red blue-grey-text">Delete Record</a>

                         </div>
                       </div>
                     </div>
                  {% endfor %}
                  <!-- END TABLE BODY -->
                </tbody>
              </table>

          </div> <!-- close col s12 -->
        </div> <!-- close row -->
      </div> <!-- close card-content -->
    </div> <!-- close card grey lighten-5 -->


        <!--  A floating button that acts as a toolbar that is available even if the
          user scrolls down -->
          <div class="fixed-action-btn click-to-toggle">
            <a class="btn-floating btn-large cyan darken-1" active>
              <i class="large material-icons">mode_edit</i>
            </a>
            <ul>
              <li>
                <a  class="btn-floating cyan darken-1 tooltipped"
                    data-position="left"
                    data-tooltip="Add Entry"
                    href="{% url 'projects:records:create' slug=project.slug %}">
                    <i class="material-icons">
                      add
                    </i>
                </a>
              </li>
              <li>
                <a  class="btn-floating yellow darken-2 tooltipped"
                    data-position="left"
                    data-tooltip="Import File"
                    href="{% url 'projects:import' slug=project.slug %}">
                    <i class="material-icons">
                      file_upload
                    </i>
                </a>
              </li>
              <li>
                <a  class="btn-floating green tooltipped"
                    data-position="left"
                    data-tooltip="Export Project"
                    href="#">
                    <i class="material-icons">
                      file_download
                    </i>
                </a>
              </li>
              <li>
                <a  class="btn-floating red tooltipped"
                    data-position="left"
                    data-tooltip="Project Settings"
                    href="{% url 'projects:settings' slug=project.slug %}">
                    <i class="material-icons">
                      edit
                    </i>
                  </a>
                </li>
            </ul>
          </div> <!-- CLOSE fixed-action-btn click-to-toggle -->
        </div> <!-- CLOSE col s12 -->
      </div> <!-- CLOSE row -->



<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

<!-- SCRIPTS TO BE MOVED TO SEPARATE FILE -->
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.material.min.js"></script>
<script>

document.addEventListener('change', function() {
  var col = document.querySelectorAll('.toggleColumn');
  renderTable(col)
 });

function renderTable(col){
  columnList = []
  for (var i = 0; i < col.length; i++) {
    columnList[i] = {
      "targets": [i],
      "visible": col[i].checked,
      className: 'mdl-data-table__cell--non-numeric',
    }
  }
  // Initializing datatables. must be reinitialized every time there is a change
  // due to how the plugin is configured. therefore destroy = true.
  $('#example').DataTable({
    // Thx to datatables.net for this jquery plugin
    "destroy":true,
    "order": [[ 2, "asc" ]],
    "scrollX": true,
    "sDom": 'frtip',
    "iDisplayLength": 20,
    "searchPlaceholder":"something",
    language: {
      search: "_INPUT_",
      searchPlaceholder: "Filter by anything...",
       "lengthMenu": "Display _MENU_ records",
    },
    "columnDefs": columnList
  });
}

jQuery(document).ready(function($) {
    $('.modal').modal();
    $('.fixed-action-btn').floatingActionButton({});
    $('.fixed-action-btn').floatingActionButton('open');
    $('select').formSelect();
    $('.tooltipped').tooltip({delay:50});
    renderTable(document.querySelectorAll('.toggleColumn'));

    $(".clickable-row").click(function() {
        window.location = $(this).data("href");
    });



});

</script>
{% endblock %}
